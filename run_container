#!/usr/bin/env bash

# Script to run either a coffea, combine, snakemake, or classifier container
# --- Helper for colored output ---
info() {
    echo -e "\033[1;34m[INFO]\033[0m $1"
}
error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}
warning() {
    echo -e "\033[1;33m[WARNING]\033[0m $1"
}


# Function to display help message
show_help() {
    echo "Usage: $0 [command] [options]"
    echo ""
    echo "Commands:"
    echo "  [command...]          Run commands inside the coffea container."
    echo "                        Opens an interactive shell if no commands are given."
    echo "                        (Interactive shell is the only option to run on LPC HTCondor)."
    echo "  combine [command...]  Run commands inside the combine container."
    echo "                        Opens an interactive shell if no commands are given."
    echo "  snakemake [options]   Run snakemake with the specified options."
    echo "                        Requires --snakefile argument."
    echo "  classifier [command...] Run commands inside the classifier container."
    echo "                        Opens an interactive shell if no commands are given."
    echo "  snakemake_dev [options] Run snakemake using the local Pixi environment for better dependency management."
    echo "                        Requires --snakefile argument. Automatically installs Pixi if needed."
    echo "  --help                Show this help message."
    echo ""
    echo "Examples:"
    echo "  $0                     Open an interactive shell in the analysis container. (This is the only option to run on LPC HTCondor)."
    echo "  $0 python --version    Run 'python --version' in the analysis container."
    echo "  $0 combine             Open an interactive shell in the combine container."
    echo "  $0 combine combine -M AsymptoticLimits  Run combine in the combine container."
    echo "  $0 snakemake --snakefile Snakefile  Run snakemake with the specified Snakefile."
    echo "  $0 snakemake_dev --snakefile Snakefile  Run snakemake with Pixi-managed environment and dependencies."
    echo "  $0 classifier          Open an interactive shell in the classifier container."
    echo "  $0 classifier python --version  Run 'python --version' in the classifier container."
}


# Define default paths
COFFEA_IMAGE="docker://gitlab-registry.cern.ch/cms-cmu/barista:latest"
COMBINE_IMAGE="docker://gitlab-registry.cern.ch/cms-analysis/general/combine-container:CMSSW_11_3_4-combine_v9.1.0-harvester_v2.1.0"
SNAKEMAKE_IMAGE="docker://gitlab-registry.cern.ch/cms-cmu/barista:reana_latest"
CLASSIFIER_IMAGE="docker://chuyuanliu/heptools:ml"

if [ -d '/cvmfs/unpacked.cern.ch' ]; then
    COFFEA_IMAGE="/cvmfs/unpacked.cern.ch/${COFFEA_IMAGE#docker://}"
    COMBINE_IMAGE="/cvmfs/unpacked.cern.ch/${COMBINE_IMAGE#docker://}"
    SNAKEMAKE_IMAGE="/cvmfs/unpacked.cern.ch/${SNAKEMAKE_IMAGE#docker://}"
    CLASSIFIER_IMAGE="/cvmfs/unpacked.cern.ch/registry.hub.docker.com/${CLASSIFIER_IMAGE#docker://}"
fi

export APPTAINER_CACHEDIR="/tmp/$(whoami)/apptainer_cache"
export APPTAINER_TMPDIR="/tmp/$(whoami)/.apptainer/"
export MPLCONFIGDIR="/tmp/$(whoami)/.config/matplotlib"

# --- Host-specific Configuration ---
info "Determining configuration for hostname: $(hostname)"
# Default Pixi installation directory
PIXI_DIR="$HOME/.pixi"
if [[ $(hostname) == *"cmslpc"* ]]; then
    export APPTAINER_BINDPATH=/uscmst1b_scratch,/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security,/uscms_data/
    # On LPC, use a shared/persistent storage area instead of $HOME
    PIXI_DIR="/uscms_data/d3/${USER}/.pixi"
    if [ ! -d "$PIXI_DIR" ]; then
        info "LPC environment detected. Pixi will be installed in ${PIXI_DIR}"
    fi
elif [[ $(hostname) == *"lxplus"* ]]; then
    export APPTAINER_BINDPATH=/afs,/eos,/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security
elif [[ $(hostname) == *"rogue"* ]]; then
    export APPTAINER_BINDPATH=/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security,/home/export/,/mnt/scratch/
elif [[ $(hostname) == *"lxplus"* ]]; then
    export APPTAINER_BINDPATH=/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security
else
   warning "Unknown hostname. Setting APPTAINER_BINDPATH to default."
fi

# Check if apptainer is installed
command -v apptainer >/dev/null 2>&1 || { error "Apptainer is not installed.  Aborting."; exit 1; }

# Function to run the coffea container
run_coffea() {

    info "Running Coffea container..."
    if [ -z "$*" ]; then
        if [[ $(hostname) == *"cmslpc"* ]]; then
            if [[ ! -f ".shell" ]]; then
                info "No .shell file found. Installing lpcjobqueue..."
                curl -OL https://raw.githubusercontent.com/CoffeaTeam/lpcjobqueue/main/bootstrap.sh
                bash bootstrap.sh
                rm bootstrap.sh
                sed -i -e 's|APPTAINER_SHELL.*|APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --pwd /srv/ \\|' -e 's|/srv/.bashrc|/srv/.bashrc|' shell
                mv shell .shell
            fi
            # For htcondor jobs
            ./.shell ../${COFFEA_IMAGE#/cvmfs/unpacked.cern.ch/}
        else
            info "Leaving the container open..."
            APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --pwd /srv/ \
            "$COFFEA_IMAGE" \
            /bin/bash 
        fi
    else
        info "Arguments provided, run them inside the container ..."
        APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --pwd /srv/ \
        "$COFFEA_IMAGE" \
        /bin/bash -c "$*"
    fi
}

# Function to run the combine container
run_combine() {

    info "Running Combine container..."

    COMBINE_SETUP="source /cvmfs/cms.cern.ch/cmsset_default.sh && cd /home/cmsusr/CMSSW_11_3_4/ && cmsenv && cd /home/cmsusr//"

    if [ -z "$*" ]; then
        info "No further arguments, just open the container..."
        APPTAINER_SHELL=$(which bash) apptainer exec -B ${PWD}:/home/cmsusr/ --pwd /home/cmsusr// \
        ${COMBINE_IMAGE} \
        /bin/bash -i -c "$COMBINE_SETUP && bash"
    else
        info "Arguments provided, run them inside the container ..."
        APPTAINER_SHELL=$(which bash) apptainer exec -B ${PWD}:/home/cmsusr/ --pwd /home/cmsusr// \
        ${COMBINE_IMAGE} \
        /bin/bash -c "$COMBINE_SETUP && $*"
    fi
}

# Function to run snakemake in container
run_snakemake() {

    info "Running Snakemake container..."
    if [ -z "$1" ]; then
        error "No arguments supplied for snakemake."
        show_help
        exit 1
    fi

    if [[ "$*" != *"--snakefile"* && "$*" != *"-s"* ]]; then
        error "The --snakefile (-s) argument is required to run snakemake."
        show_help
        exit 1
    fi

    info "Executing Snakemake command inside the container..."
    APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --pwd /srv/ \
    "$SNAKEMAKE_IMAGE" \
    /bin/bash -c "snakemake $*"

    info "Workflow execution finished successfully!. Try to run snakemake_dev for better dependency management."
}

# Function to run snakemake
run_snakemake_dev() {
    info "Running Snakemake with Pixi environment..."
    set -eo pipefail

    if [ -z "$1" ]; then
        error "No arguments supplied for snakemake."
        show_help
        exit 1
    fi

    local PIXI_CONFIG="software/pixi/pixi.toml"

    # 1. Check for and Install Pixi
    if ! command -v pixi &> /dev/null; then
        info "Pixi not found. Installing to ${PIXI_DIR}..."
        export PIXI_HOME="${PIXI_DIR}"
        mkdir -p "${PIXI_DIR}"
        
        if ! curl -fsSL https://pixi.sh/install.sh | bash; then
            error "Failed to install Pixi. Check network connection and permissions."
            exit 1
        fi

        export PATH="${PIXI_DIR}/bin:$PATH"
        
        if ! command -v pixi &> /dev/null; then
            error "Pixi installation failed or PATH not updated correctly."
            echo "Please restart your shell and try again."
            exit 1
        fi
        info "Pixi installed successfully."
    else
        info "Pixi found at: $(command -v pixi)"
    fi

    # 2. Sync pixi.toml from template (always use latest from software/pixi/)
    if [ -f "${PIXI_CONFIG}" ]; then
        info "Syncing pixi.toml from ${PIXI_CONFIG}..."
        cp "${PIXI_CONFIG}" pixi.toml
    else
        error "No pixi configuration template found at ${PIXI_CONFIG}"
        error "Please create ${PIXI_CONFIG} first."
        exit 1
    fi

    # 3. Install environment
    info "Installing Pixi environment..."
    if ! pixi install; then
        error "Failed to install Pixi environment. Check pixi.toml for issues."
        exit 1
    fi

    # 4. Verify Snakemake is available
    if ! pixi run python -c "import snakemake" 2>/dev/null; then
        error "Snakemake not available in environment. Check dependencies in pixi.toml."
        exit 1
    fi

    # 5. Run Snakemake
    info "Executing: pixi run snakemake $*"
    pixi run snakemake "$@"
    
    info "Workflow execution finished successfully!"
}


# Function to run the classifier container
run_classifier() {
    info "Running Classifier container..."
    INIT_FILE="/entrypoint.sh"
    if [ -z "$*" ]; then
        info "No arguments provided, opening interactive shell in classifier container..."
        APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --nv --pwd /srv \
        "$CLASSIFIER_IMAGE" \
        bash --init-file "$INIT_FILE"
    else
        info "Arguments provided, running them inside the classifier container ..."
        APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --nv --pwd /srv \
        "$CLASSIFIER_IMAGE" \
        bash --init-file "$INIT_FILE" -c "$*"

        info "Workflow execution finished successfully!"

    fi
}


# Main logic: check arguments and run the appropriate container
if [ "$1" == "--help" ]; then
    show_help
    exit 0
fi

if [ -z "$1" ]; then
    # If no arguments, just run coffea with the default image
    run_coffea
else
    case "$1" in
        "combine")
        run_combine "${@:2}" # Run combine, passing along any remaining arguments
        ;;
        "snakemake")
        run_snakemake "${@:2}" # Run snakemake, passing along any remaining arguments
        ;;
        "snakemake_dev")
        run_snakemake_dev "${@:2}" # Run snakemake, passing along any remaining arguments
        ;;
        "classifier")
        run_classifier "${@:2}" # Run classifier, passing along any remaining arguments
        ;;
        *)
        # If not combine or snakemake, assume the arguments are commands for coffea
        run_coffea "$@"
        ;;
    esac
fi