#!/usr/bin/env bash

# --- Configuration ---
# Image Definitions
COFFEA_IMAGE="docker://gitlab-registry.cern.ch/cms-cmu/barista:latest"
COMBINE_IMAGE="docker://gitlab-registry.cern.ch/cms-analysis/general/combine-container:CMSSW_11_3_4-combine_v9.1.0-harvester_v2.1.0"
SNAKEMAKE_IMAGE="docker://gitlab-registry.cern.ch/cms-cmu/barista:reana_latest"
CLASSIFIER_IMAGE="docker://chuyuanliu/heptools:ml"
BRILCALC_IMAGE="docker://gitlab-registry.cern.ch/cms-cloud/brilws-docker:latest"

# Resolve CVMFS paths if available
if [ -d '/cvmfs/unpacked.cern.ch' ]; then
    COFFEA_IMAGE="/cvmfs/unpacked.cern.ch/${COFFEA_IMAGE#docker://}"
    COMBINE_IMAGE="/cvmfs/unpacked.cern.ch/${COMBINE_IMAGE#docker://}"
    SNAKEMAKE_IMAGE="/cvmfs/unpacked.cern.ch/${SNAKEMAKE_IMAGE#docker://}"
    CLASSIFIER_IMAGE="/cvmfs/unpacked.cern.ch/registry.hub.docker.com/${CLASSIFIER_IMAGE#docker://}"
    BRILCALC_IMAGE="/cvmfs/unpacked.cern.ch/${BRILCALC_IMAGE#docker://}"
fi

# Directories
export APPTAINER_CACHEDIR="/tmp/$(whoami)/apptainer_cache"
export APPTAINER_TMPDIR="/tmp/$(whoami)/.apptainer/"
export MPLCONFIGDIR="/tmp/$(whoami)/.config/matplotlib"
PIXI_DIR="$HOME/.pixi"

mkdir -p "$APPTAINER_CACHEDIR" "$APPTAINER_TMPDIR" "$MPLCONFIGDIR"

# --- Helpers ---
info() { echo -e "\033[1;34m[INFO]\033[0m $1"; }
error() { echo -e "\033[1;31m[ERROR]\033[0m $1"; }
warning() { echo -e "\033[1;33m[WARNING]\033[0m $1"; }

check_apptainer() {
    command -v apptainer >/dev/null 2>&1 || { error "Apptainer is not installed. Aborting."; exit 1; }
}

show_help() {
    cat << EOF
Usage: $0 [command] [options]

Commands:
  [command...]          Run commands inside the coffea container.
                        (Interactive shell is the only option to run on LPC HTCondor).
  combine [cmd...]      Run commands inside the combine container.
  classifier [cmd...]   Run commands inside the classifier container.
  brilcalc [cmd...]     Run commands inside the brilcalc container.
  snakemake [opts]      Run snakemake using the local Pixi environment.
                        Use --reinstall to clean environment.
  snakemake_container   Run snakemake inside a container (backup option).
  --help                Show this help message.

Examples:
  $0                     Open interactive shell (Coffea).
  $0 python script.py    Run script in Coffea container.
  $0 combine             Open Combine container.
  $0 snakemake -s Snakefile
EOF
}

# --- Host Detection & Setup ---
setup_host_env() {
    info "Determining configuration for hostname: $(hostname)"
    if [[ $(hostname) == *"cmslpc"* ]]; then
        export APPTAINER_BINDPATH="/uscmst1b_scratch,/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security,/uscms_data/"
        PIXI_DIR="/uscms_data/d3/${USER}/.pixi"
        if [ ! -d "$PIXI_DIR" ]; then
            info "LPC environment detected. Pixi will be installed in ${PIXI_DIR}"
        fi
    elif [[ $(hostname) == *"lxplus"* ]]; then
        export APPTAINER_BINDPATH=/afs,/eos,/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security
    elif [[ $(hostname) == *"rogue"* ]]; then
        export APPTAINER_BINDPATH=/cvmfs,/cvmfs/grid.cern.ch/etc/grid-security:/etc/grid-security,/home/export/,/mnt/scratch/
    else
        warning "Unknown hostname. Setting APPTAINER_BINDPATH to default."
    fi
}

# --- LPC Specific Logic ---
setup_lpc_jobqueue() {
    # Only run on LPC
    [[ $(hostname) != *"cmslpc"* ]] && return 0

    # Bootstrap if missing
    if [[ ! -f ".bashrc" || ! -f ".cmslpc-local-conf" ]]; then
        info "Setting up lpcjobqueue configuration..."
        curl -OL https://raw.githubusercontent.com/CoffeaTeam/lpcjobqueue/main/bootstrap.sh
        bash bootstrap.sh
        rm bootstrap.sh shell
    else
        info "lpcjobqueue configuration found. Skipping bootstrap."
    fi

    # Define LPC specific variables and binds
    local LPC_CONDOR_CONFIG="/etc/condor/config.d/01_cmslpc_interactive"
    local LPC_CONDOR_LOCAL="/usr/local/bin/cmslpc-local-conf.py"
    
    export APPTAINER_BINDPATH="${APPTAINER_BINDPATH},${LPC_CONDOR_CONFIG},${LPC_CONDOR_LOCAL}:${LPC_CONDOR_LOCAL}.orig,${PWD}/.cmslpc-local-conf:${LPC_CONDOR_LOCAL}"
}

# --- Container Functions ---

run_coffea() {
    check_apptainer
    info "Running Coffea container..."
    setup_lpc_jobqueue

    # Base flags for apptainer
    local FLAGS=( -B "$PWD":/srv --pwd /srv/ )
    
    # Add LPC specific env var if needed
    if [[ $(hostname) == *"cmslpc"* ]]; then
        FLAGS+=( --env COFFEA_IMAGE_FULL="$COFFEA_IMAGE" )
    fi

    if [ -z "$*" ]; then
        # Interactive Mode
        if [[ $(hostname) == *"cmslpc"* ]]; then
            info "Opening interactive shell with lpcjobqueue environment..."
            APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$COFFEA_IMAGE" /bin/bash --rcfile /srv/.bashrc
        else
            info "Opening interactive shell..."
            APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$COFFEA_IMAGE" /bin/bash
        fi
    else
        # Non-Interactive Mode
        info "Running command inside container..."
        local CMD="$*"
        if [[ $(hostname) == *"cmslpc"* ]]; then
            APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$COFFEA_IMAGE" /bin/bash -c "source /srv/.bashrc && $CMD"
        else
            APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$COFFEA_IMAGE" /bin/bash -c "$CMD"
        fi
    fi
}

run_combine() {
    check_apptainer
    info "Running Combine container..."
    local SETUP="source /cvmfs/cms.cern.ch/cmsset_default.sh && cd /home/cmsusr/CMSSW_11_3_4/ && cmsenv && cd /home/cmsusr/barista/"
    local FLAGS=( -B "${PWD}:/home/cmsusr/barista/" --pwd /home/cmsusr/barista/ )

    if [ -z "$*" ]; then
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "${COMBINE_IMAGE}" /bin/bash -i -c "$SETUP && bash"
    else
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "${COMBINE_IMAGE}" /bin/bash -c "$SETUP && $*"
    fi
}

run_brilcalc() {
    check_apptainer
    info "Running Brilcalc container..."
    local FLAGS=( -B "${PWD}:/srv" --pwd /srv/ --env PYTHONPATH=/home/bril/.local/lib/python3.10/site-packages )

    if [ -z "$*" ]; then
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "${BRILCALC_IMAGE}" /bin/bash
    else
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "${BRILCALC_IMAGE}" /bin/bash -c "$*"
    fi
}

run_classifier() {
    check_apptainer
    info "Running Classifier container..."
    local INIT_FILE="/entrypoint.sh"
    local FLAGS=( -B "$PWD":/srv --nv --pwd /srv )

    if [ -z "$*" ]; then
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$CLASSIFIER_IMAGE" bash --init-file "$INIT_FILE"
    else
        APPTAINER_SHELL=$(which bash) apptainer exec "${FLAGS[@]}" "$CLASSIFIER_IMAGE" bash --init-file "$INIT_FILE" -c "$*"
    fi
}

run_snakemake_container() {
    check_apptainer
    info "Running Snakemake container..."
    [[ -z "$1" ]] && { error "No arguments supplied."; show_help; exit 1; }
    [[ "$*" != *"--snakefile"* && "$*" != *"-s"* ]] && { error "--snakefile (-s) argument required."; exit 1; }

    APPTAINER_SHELL=$(which bash) apptainer exec -B "$PWD":/srv --pwd /srv/ "$SNAKEMAKE_IMAGE" /bin/bash -c "snakemake $*"
}

# --- Pixi / Snakemake Local ---

install_pixi() {
    if ! command -v pixi &> /dev/null; then
        info "Installing Pixi to ${PIXI_DIR}..."
        export PIXI_HOME="${PIXI_DIR}"
        mkdir -p "${PIXI_DIR}"
        curl -fsSL https://pixi.sh/install.sh | bash || return 1
        export PATH="${PIXI_DIR}/bin:$PATH"
    fi
    command -v pixi &> /dev/null || return 1
}

run_snakemake() {
    info "Running Snakemake with Pixi environment..."
    set -eo pipefail

    local REINSTALL=false
    local ARGS=()
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --reinstall|--fresh) REINSTALL=true; shift ;;
            --help|-h) ARGS+=("--help"); shift ;;
            source) ARGS+=("$@"); break ;;
            *) ARGS+=("$1"); shift ;;
        esac
    done

    [[ ${#ARGS[@]} -eq 0 && "$REINSTALL" != true ]] && { error "No arguments supplied."; show_help; exit 1; }

    # Install Pixi
    install_pixi || { error "Pixi installation failed."; exit 1; }

    # Reinstall logic
    if [ "$REINSTALL" = true ]; then
        info "Cleaning up environment..."
        rm -f pixi.toml pixi.lock
    fi

    # Sync Config
    local PIXI_CONFIG="software/pixi/pixi.toml"
    if [ -f "${PIXI_CONFIG}" ]; then
        cp "${PIXI_CONFIG}" pixi.toml
    else
        error "Template ${PIXI_CONFIG} not found."; exit 1
    fi

    # Install Environment
    pixi install || { error "Pixi install failed."; exit 1; }

    # Install Reana Client (Custom)
    if ! pixi run python -c "import reana_client" 2>/dev/null; then
        info "Installing reana-client..."
        pixi run install-reana || warning "reana-client install failed."
    fi

    # Execute
    if [ "${ARGS[0]}" = "source" ]; then
        pixi run bash -c "${ARGS[*]}"
    else
        pixi run snakemake "${ARGS[@]}"
    fi
    info "Execution finished successfully!"
}

# --- Main Dispatch ---

setup_host_env

if [ "$1" == "--help" ]; then
    show_help
    exit 0
fi

case "$1" in
    "combine")             run_combine "${@:2}" ;;
    "brilcalc")            run_brilcalc "${@:2}" ;;
    "snakemake_container") run_snakemake_container "${@:2}" ;;
    "snakemake")           run_snakemake "${@:2}" ;;
    "classifier")          run_classifier "${@:2}" ;;
    *)                     run_coffea "$@" ;;
esac